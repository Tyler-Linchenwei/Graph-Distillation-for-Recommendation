# Rankformer æ‰§è¡Œæµç¨‹å›¾

## ğŸ¯ å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¨‹åºå¯åŠ¨ (main.py)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è§£æå‚æ•° (parse.py)                                          â”‚
â”‚     - è¯»å–å‘½ä»¤è¡Œå‚æ•°                                             â”‚
â”‚     - è®¾ç½®è®¾å¤‡(CPU/GPU)                                          â”‚
â”‚     - è®¾ç½®éšæœºç§å­                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åŠ è½½æ•°æ® (dataloader.py)                                     â”‚
â”‚     - è¯»å– train.txt / valid.txt / test.txt                     â”‚
â”‚     - ç»Ÿè®¡ num_users, num_items                                 â”‚
â”‚     - æ„å»ºè¯„ä¼°æ‰¹æ¬¡ (batch_users, train_batch, test_batch)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆå§‹åŒ–æ¨¡å‹ (Model.__init__)                                  â”‚
â”‚     - åˆ›å»º embedding_user [num_users, hidden_dim]              â”‚
â”‚     - åˆ›å»º embedding_item [num_items, hidden_dim]              â”‚
â”‚     - åˆ›å»º GCN å’Œ Rankformer ç»„ä»¶                               â”‚
â”‚     - åˆ›å»ºä¼˜åŒ–å™¨ (Adam)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. åˆå§‹éªŒè¯ (epoch=0)                                           â”‚
â”‚     - computer() â†’ è®¡ç®—åˆå§‹åµŒå…¥                                  â”‚
â”‚     - evaluate() â†’ è®¡ç®—éªŒè¯é›†æŒ‡æ ‡                                â”‚
â”‚     - æ‰“å°åˆå§‹æ€§èƒ½                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®­ç»ƒå¾ªç¯å¼€å§‹                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  epoch = 1    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. è®­ç»ƒä¸€ä¸ª Epoch                â”‚
        â”‚     train()                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5.1 train_func()                 â”‚
        â”‚     - å¦‚æœ loss_batch_size=0:    â”‚
        â”‚       å…¨é‡è®­ç»ƒ                    â”‚
        â”‚     - å¦åˆ™:                      â”‚
        â”‚       æ‰¹é‡è®­ç»ƒï¼ˆæ‰“ä¹±æ•°æ®ï¼‰        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5.2 train_func_one_batch(u, i)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5.3 computer() - è®¡ç®—åµŒå…¥         â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 1. è·å–åŸå§‹åµŒå…¥          â”‚  â”‚
        â”‚     â”‚    all_emb = concat(     â”‚  â”‚
        â”‚     â”‚        users_emb,        â”‚  â”‚
        â”‚     â”‚        items_emb)       â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 2. GCNä¼ æ’­ (å¯é€‰)       â”‚  â”‚
        â”‚     â”‚    for layer in range:  â”‚  â”‚
        â”‚     â”‚        all_emb = GCN(   â”‚  â”‚
        â”‚     â”‚            all_emb,     â”‚  â”‚
        â”‚     â”‚            u_train,      â”‚  â”‚
        â”‚     â”‚            i_train)      â”‚  â”‚
        â”‚     â”‚    (å¯é€‰: æ·»åŠ CLå™ªå£°)   â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 3. Rankformerä¼ æ’­(å¯é€‰)  â”‚  â”‚
        â”‚     â”‚    for layer in range:  â”‚  â”‚
        â”‚     â”‚        rec_emb =        â”‚  â”‚
        â”‚     â”‚            Rankformer(  â”‚  â”‚
        â”‚     â”‚                all_emb, â”‚  â”‚
        â”‚     â”‚                u_train, â”‚  â”‚
        â”‚     â”‚                i_train) â”‚  â”‚
        â”‚     â”‚        all_emb =        â”‚  â”‚
        â”‚     â”‚            (1-tau)*     â”‚  â”‚
        â”‚     â”‚            all_emb +    â”‚  â”‚
        â”‚     â”‚            tau*rec_emb  â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 4. åˆ†å‰²å¹¶ä¿å­˜            â”‚  â”‚
        â”‚     â”‚    self._users,          â”‚  â”‚
        â”‚     â”‚    self._items =         â”‚  â”‚
        â”‚     â”‚        split(all_emb)   â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5.4 loss_bpr(u, i) - è®¡ç®—æŸå¤±    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 1. è´Ÿé‡‡æ ·               â”‚  â”‚
        â”‚     â”‚    j = negative_        â”‚  â”‚
        â”‚     â”‚        sampling(u,i)   â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 2. è·å–åµŒå…¥              â”‚  â”‚
        â”‚     â”‚    u_emb = _users[u]    â”‚  â”‚
        â”‚     â”‚    i_emb = _items[i]    â”‚  â”‚
        â”‚     â”‚    j_emb = _items[j]    â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 3. è®¡ç®—åˆ†æ•°              â”‚  â”‚
        â”‚     â”‚    scores_ui =          â”‚  â”‚
        â”‚     â”‚        (u_emb*i_emb)   â”‚  â”‚
        â”‚     â”‚    scores_uj =          â”‚  â”‚
        â”‚     â”‚        (u_emb*j_emb)   â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 4. BPRæŸå¤±              â”‚  â”‚
        â”‚     â”‚    loss = softplus(     â”‚  â”‚
        â”‚     â”‚        scores_uj -     â”‚  â”‚
        â”‚     â”‚        scores_ui)      â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 5. L2æ­£åˆ™åŒ–             â”‚  â”‚
        â”‚     â”‚    reg_loss = ||emb||Â²  â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚     â”‚ 6. å¯¹æ¯”å­¦ä¹ æŸå¤±(å¯é€‰)   â”‚  â”‚
        â”‚     â”‚    cl_loss = InfoNCE() â”‚  â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚              â†“                    â”‚
        â”‚     â”‚ loss_total = loss +        â”‚
        â”‚     â”‚            reg + cl        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5.5 åå‘ä¼ æ’­å’Œæ›´æ–°               â”‚
        â”‚     optimizer.zero_grad()        â”‚
        â”‚     loss.backward()              â”‚
        â”‚     optimizer.step()             â”‚
        â”‚     (æ›´æ–° embedding_user/item)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ epoch %        â”‚
                    â”‚ valid_interval â”‚
                    â”‚ == 0?          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    Yes â†“        No â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  6. éªŒè¯           â”‚    â”‚
        â”‚     valid(epoch)   â”‚    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                  â†“               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  6.1 valid_func()  â”‚    â”‚
        â”‚     evaluate(      â”‚    â”‚
        â”‚         valid_     â”‚    â”‚
        â”‚         batch)     â”‚    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                  â†“               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  6.2 evaluate()    â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 1. computerâ”‚  â”‚    â”‚
        â”‚     â”‚    ()     â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â”‚           â†“         â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 2. æ‰¹æ¬¡    â”‚  â”‚    â”‚
        â”‚     â”‚   å¤„ç†ç”¨æˆ· â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â”‚           â†“         â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 3. è®¡ç®—   â”‚  â”‚    â”‚
        â”‚     â”‚   è¯„åˆ†çŸ©é˜µâ”‚  â”‚    â”‚
        â”‚     â”‚   rating =â”‚  â”‚    â”‚
        â”‚     â”‚   user_embâ”‚  â”‚    â”‚
        â”‚     â”‚   @       â”‚  â”‚    â”‚
        â”‚     â”‚   item_   â”‚  â”‚    â”‚
        â”‚     â”‚   emb.T   â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â”‚           â†“         â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 4. æ’é™¤    â”‚  â”‚    â”‚
        â”‚     â”‚   è®­ç»ƒé›†   â”‚  â”‚    â”‚
        â”‚     â”‚   äº¤äº’     â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â”‚           â†“         â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 5. Top-K  â”‚  â”‚    â”‚
        â”‚     â”‚   æ¨è     â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â”‚           â†“         â”‚    â”‚
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
        â”‚     â”‚ 6. è®¡ç®—    â”‚  â”‚    â”‚
        â”‚     â”‚   æŒ‡æ ‡     â”‚  â”‚    â”‚
        â”‚     â”‚   (Pre/    â”‚  â”‚    â”‚
        â”‚     â”‚    Recall/ â”‚  â”‚    â”‚
        â”‚     â”‚    NDCG)   â”‚  â”‚    â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                  â†“               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  6.3 æ£€æŸ¥æ˜¯å¦æœ€ä½³  â”‚    â”‚
        â”‚     if valid_ndcg â”‚    â”‚
        â”‚        > best:    â”‚    â”‚
        â”‚        åœ¨æµ‹è¯•é›†    â”‚    â”‚
        â”‚        ä¸Šè¯„ä¼°      â”‚    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                  â†“               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
        â”‚  6.4 æ—©åœæ£€æŸ¥      â”‚    â”‚
        â”‚     if è¿ç»­        â”‚    â”‚
        â”‚     stopping_step â”‚    â”‚
        â”‚     æ¬¡æœªæå‡:      â”‚    â”‚
        â”‚        break      â”‚    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                  â†“               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ epoch += 1    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ epoch <=      â”‚
                    â”‚ max_epochs?   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    Yes â†‘        No â†“
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ 7. è®­ç»ƒå®Œæˆ    â”‚
                            â”‚    æ‰“å°æœ€ç»ˆ    â”‚
                            â”‚    æµ‹è¯•ç»“æœ    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å…³é”®å¾ªç¯è¯´æ˜

### è®­ç»ƒå¾ªç¯ï¼ˆå¤–å±‚ï¼‰
```
for epoch in range(1, max_epochs+1):
    1. train() - è®­ç»ƒä¸€ä¸ªepoch
    2. if epoch % valid_interval == 0:
        3. valid() - éªŒè¯
        4. æ—©åœæ£€æŸ¥
```

### è®­ç»ƒå¾ªç¯ï¼ˆå†…å±‚ - å¦‚æœä½¿ç”¨æ‰¹é‡è®­ç»ƒï¼‰
```
for batch in batches:
    1. computer() - è®¡ç®—åµŒå…¥
    2. loss_bpr() - è®¡ç®—æŸå¤±
    3. backward() - åå‘ä¼ æ’­
    4. step() - æ›´æ–°å‚æ•°
```

### è¯„ä¼°å¾ªç¯
```
for batch_users in batch_users_list:
    1. è®¡ç®—è¯„åˆ†çŸ©é˜µ
    2. æ’é™¤è®­ç»ƒé›†äº¤äº’
    3. Top-Kæ¨è
    4. è®¡ç®—æŒ‡æ ‡
```

## ğŸ“Š æ•°æ®æµå›¾

```
åŸå§‹åµŒå…¥ (embedding_user/item)
    â†“
[GCNä¼ æ’­] (å¯é€‰)
    â†“
[Rankformerä¼ æ’­] (å¯é€‰)
    â†“
æœ€ç»ˆåµŒå…¥ (_users, _items)
    â†“
    â”œâ”€â†’ [è®­ç»ƒ] â†’ loss_bpr() â†’ backward() â†’ æ›´æ–°åŸå§‹åµŒå…¥
    â”‚
    â””â”€â†’ [è¯„ä¼°] â†’ è¯„åˆ†çŸ©é˜µ â†’ Top-Kæ¨è â†’ æŒ‡æ ‡è®¡ç®—
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç‚¹

1. **æ‰¹é‡è®­ç»ƒ**: ä½¿ç”¨`loss_batch_size`é¿å…å†…å­˜æº¢å‡º
2. **è¯„ä¼°æ‰¹æ¬¡**: ä½¿ç”¨`test_batch_size`åˆ†æ‰¹å¤„ç†ç”¨æˆ·
3. **æ¢¯åº¦ç¦ç”¨**: è¯„ä¼°æ—¶ä½¿ç”¨`torch.no_grad()`èŠ‚çœå†…å­˜
4. **ç¼“å­˜åµŒå…¥**: `computer()`çš„ç»“æœä¿å­˜åœ¨`_users`å’Œ`_items`ä¸­
